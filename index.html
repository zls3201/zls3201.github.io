<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8" />

    <title>天水阁</title>
    <meta description="为卿采莲兮涉水 为卿夺旗兮长战 为卿遥望兮辞宫阙 为卿白发兮缓缓歌" />
    <script src="static/js/avalon.js"></script>
    <script src="static/js/stateman.js"></script>
    <script src="static/js/fetch.js"></script>
    <script src="static/js/handlebars-v4.0.5.js"></script>
</head>

<body ms-controller="test">
    <div class="headbar"> </div>
    <div class="sidebar"></div>
    <div class="main">
        <div class="post" ms-for="item in @posts">
            <p ms-html="item.title"></p>
            <p ms-html="item.content"></p>
        </div>
        <ms-pager ms-widget="{$id:'pager',pageIndex:@pageIndex,pageCount:@pageCount}"></ms-pager>
    </div>

    <input ms-duplex="@name"> {{@pageCount}}
    <p>Hello,{{@name}}!</p>
    <p>Hello,{{@pageCount}}!</p>
</body>
<script>
    avalon.component('ms-pager', {
        template: "<div><span>{{@pageIndex}} </span><span> {{@pageCount}}</span></div>",
        defaults: {
            pageIndex: 0,
            pageCount: 3
        }
    });

    var vm = avalon.define({
        $id: "test",
        name: "",
        posts: [],
        pageIndex: 0,
        pageSize:2,
        pageCount: 0,
        totalCount: 0,
        fetchPosts: function(_pageIndex) {
            var that = this;
            fetch('/post.json')
                .then(function(response) {
                    return response.json()
                }).then(function(json) {
                    console.log('parsed json', json);
                    that.totalCount = json.length;
                    that.pageCount = Math.round(that.totalCount / that.pageSize);
                    that.posts = json.slice(_pageIndex * that.pageSize, that.pageSize);
                }).catch(function(ex) {
                    console.log('parsing failed', ex)
                });
        }
    });

    vm.fetchPosts(0);
</script>

</html>